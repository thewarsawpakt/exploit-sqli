// Decompiled with JetBrains decompiler
// Type: SearchEngine
// Assembly: SQLi Dumper, Version=8.5.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FFDD07D3-5737-4188-BACA-DE2D004C7CCF
// Assembly location: C:\Users\cole\Desktop\SQLi Dumper v8.5 [VeryClean]\SQLi v.8.5 VeryClean by Stephanny.exe

using Microsoft.VisualBasic;
using Microsoft.VisualBasic.CompilerServices;
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Runtime.CompilerServices;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Web;
using System.Windows.Forms;

public class SearchEngine
{
  private SearchEngine.Host __Host;
  private CookieCollection __Cookie;
  private int __Retry;
  private int __TimeOut;
  private SearchEngine.Worker __State;
  private ThreadPool __ThreadPool;
  private int __Delay;
  private int __Threads;
  private List<string> __Dorks;
  private List<WebProxy> __BlackListProxy;
  [SpecialName]
  private long .STATIC.ScannerDelay.2001.LastTick;

  public int Progress { get; set; }

  public int LinksLoaded { get; set; }

  public SearchEngine(SearchEngine.Host h, int iRetry, int iTimeOut)
  {
    this.__Host = h;
    this.__Retry = iRetry;
    this.__TimeOut = iTimeOut;
    this.__State = SearchEngine.Worker.Ide;
    this.__Cookie = new CookieCollection();
  }

  public event SearchEngine.Scanner_ProgressEventHandler Scanner_Progress;

  public event SearchEngine.Scanner_LoadedLinkEventHandler Scanner_LoadedLink;

  public event SearchEngine.Scanner_DoneEventHandler Scanner_Done;

  public bool Complete() => this.__State == SearchEngine.Worker.Ide;

  private bool ScannerStoped()
  {
    while (this.__State != SearchEngine.Worker.Ide && this.__State != SearchEngine.Worker.Working)
      Thread.Sleep(500);
    return this.__State == SearchEngine.Worker.Ide;
  }

  private void ScannerDelay()
  {
    if (this.__Delay == 0)
      return;
    if (this..STATIC.ScannerDelay.2001.LastTick < 1L)
      this..STATIC.ScannerDelay.2001.LastTick = 1L;
    while (checked ((long) Math.Round(unchecked ((double) DateTime.UtcNow.Ticks / 10000.0)) - this..STATIC.ScannerDelay.2001.LastTick) <= (long) this.__Delay)
    {
      Thread.Sleep(100);
      Application.DoEvents();
      if (this.ScannerStoped())
        break;
    }
    this..STATIC.ScannerDelay.2001.LastTick = checked ((long) Math.Round(unchecked ((double) DateTime.UtcNow.Ticks / 10000.0)));
  }

  public void StartScanning(List<string> dorks, int threads, int delay)
  {
    if (this.__State != SearchEngine.Worker.Ide)
    {
      int num = (int) MessageBox.Show("Scanner already running!");
    }
    else
    {
      if (dorks.Count <= threads)
        threads = dorks.Count;
      this.__ThreadPool = new ThreadPool(threads);
      this.__BlackListProxy = new List<WebProxy>();
      this.Progress = 0;
      this.LinksLoaded = 0;
      this.__Delay = delay;
      this.__Dorks = dorks;
      this.__Threads = threads;
      this.__State = SearchEngine.Worker.Working;
      new Thread(new ThreadStart(this.DoWork)).Start();
    }
  }

  private void DoWork()
  {
    try
    {
      if (this.__Dorks.Count <= this.__Threads)
        this.__Threads = this.__Dorks.Count;
      this.__ThreadPool = new ThreadPool(this.__Threads);
      int count = this.__Dorks.Count;
      int num = checked (count - 1);
      int index = 0;
      while (index <= num && !this.ScannerStoped())
      {
        this.Progress = checked ((int) Math.Round(Math.Round(unchecked ((double) checked (100 * index) / (double) count))));
        SearchEngine.Scanner_ProgressEventHandler scannerProgressEvent = this.Scanner_ProgressEvent;
        if (scannerProgressEvent != null)
          scannerProgressEvent(this.Progress, this.__Host);
        Thread thread = new Thread((ParameterizedThreadStart) (a0 => this.ScannThread((SearchEngine.ThreadScanner) a0)));
        thread.Start((object) new SearchEngine.ThreadScanner()
        {
          Thread = thread,
          Dork = this.__Dorks[index]
        });
        this.__ThreadPool.Open(thread);
        this.__ThreadPool.WaitForThreads();
        checked { ++index; }
      }
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      ProjectData.ClearProjectError();
    }
    finally
    {
      this.__ThreadPool.AllJobsPushed();
      do
        ;
      while (!this.ScannerStoped() && (!this.__ThreadPool.Finished && this.__ThreadPool.ThreadCount != 0));
      this.__State = SearchEngine.Worker.Ide;
      this.Progress = 100;
      SearchEngine.Scanner_DoneEventHandler scannerDoneEvent = this.Scanner_DoneEvent;
      if (scannerDoneEvent != null)
        scannerDoneEvent(this.__Host);
    }
  }

  public void StopScanning() => this.__State = SearchEngine.Worker.Ide;

  public void PauseScanning(bool state)
  {
    if (this.__State == SearchEngine.Worker.Ide)
      return;
    if (state)
      this.__State = SearchEngine.Worker.Paused;
    else
      this.__State = SearchEngine.Worker.Working;
  }

  private void ScannThread(SearchEngine.ThreadScanner t)
  {
    try
    {
      int iPage = 0;
      do
      {
        bool bNextPage = false;
        List<string> links = this.GetLinks(t.Dork, iPage, ref bNextPage);
        if (links.Count > 0)
          goto label_3;
label_1:
        if (bNextPage && !this.ScannerStoped())
        {
          checked { ++iPage; }
          continue;
        }
        goto label_7;
label_3:
        SearchEngine.Scanner_LoadedLinkEventHandler scannerLoadedLinkEvent = this.Scanner_LoadedLinkEvent;
        if (scannerLoadedLinkEvent != null)
        {
          scannerLoadedLinkEvent(links, this.__Host);
          goto label_1;
        }
        else
          goto label_1;
      }
      while (iPage <= 100);
      goto label_6;
label_7:
      return;
label_6:;
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      Thread.Sleep(2000);
      this.__ThreadPool.Close(t.Thread);
      ProjectData.ClearProjectError();
    }
  }

  private WebProxy GetProxy(ref bool AllBlacklisted)
  {
    if (!Globals.G_Proxy.Enable)
      return (WebProxy) null;
    WebProxy proxy;
    do
    {
      proxy = Globals.G_Proxy.Proxy;
      if (Globals.G_Proxy.List.Count == this.__BlackListProxy.Count)
        goto label_3;
    }
    while (this.__BlackListProxy.Contains(proxy));
    goto label_4;
label_3:
    AllBlacklisted = true;
    return proxy;
label_4:
    return proxy;
  }

  private List<string> GetLinks(string sQuery, int iPage, ref bool bNextPage)
  {
    List<string> stringList = new List<string>();
    string address = this.GetAddress(sQuery, iPage);
    int retry1 = this.__Retry;
    int num1 = 1;
    while (num1 <= retry1)
    {
      WebProxy proxy = this.GetProxy(ref bNextPage);
      if (!bNextPage)
      {
        if (!this.ScannerStoped())
        {
          string sData = this.LoadPage(address, proxy);
          if (this.CheckedCaptcha(sData))
          {
            if (!Information.IsNothing((object) proxy))
            {
              if (!this.__BlackListProxy.Contains(proxy))
              {
                this.__BlackListProxy.Add(proxy);
                goto label_18;
              }
            }
            else
            {
              bNextPage = false;
              return stringList;
            }
          }
          if (this.__Host == SearchEngine.Host.Aol)
          {
            if (iPage == 0 && !sData.ToLower().Contains(">Web Results</h3>".ToLower()))
              sData = this.LoadPage(address, proxy);
          }
          else if (this.__Host == SearchEngine.Host.Google && sData.ToLower().Contains("style=\"display:block\">".ToLower()))
          {
            sData = sData.Substring(sData.IndexOf("tyle=\"display:block\">"));
            stringList = this.RegExp("\\s+href\\s*=\\s*\"?([^\" >]+)\"", sData);
            if (stringList.Count > 0)
            {
              int retry2 = this.__Retry;
              int num2 = 1;
              while (num2 <= retry2)
              {
                sData = this.LoadPage(stringList[0], proxy);
                if (string.IsNullOrEmpty(sData))
                  checked { ++num2; }
                else
                  break;
              }
              stringList.Clear();
              num1 = this.__Retry;
            }
          }
          if (!string.IsNullOrEmpty(sData) && this.IsValidePage(sData, ref bNextPage))
          {
            stringList = this.ParseURLs(sData);
            break;
          }
label_18:
          checked { ++num1; }
        }
        else
          break;
      }
      else
      {
        bNextPage = false;
        return stringList;
      }
    }
    return stringList;
  }

  private string GetAddress(string sQuery, int iPage)
  {
    StringBuilder stringBuilder = new StringBuilder();
    switch (this.__Host)
    {
      case SearchEngine.Host.Google:
        stringBuilder.Append("https://www.google.com/search?");
        stringBuilder.Append("newwindow=1");
        stringBuilder.Append("&site=");
        stringBuilder.Append("&q=" + HttpUtility.UrlEncode(sQuery));
        stringBuilder.Append("&start=" + Conversions.ToString(checked (iPage * 100)));
        stringBuilder.Append("&num=100");
        break;
      case SearchEngine.Host.Bing:
        stringBuilder.Append("http://www.bing.com/search?");
        stringBuilder.Append("q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
          stringBuilder.Append("&first=" + Conversions.ToString(checked (iPage * 50)));
        stringBuilder.Append("&count=50");
        break;
      case SearchEngine.Host.Yahoo:
        stringBuilder.Append("http://search.yahoo.com/search?");
        stringBuilder.Append("n=100");
        stringBuilder.Append("&p=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&b=" + Conversions.ToString(checked (iPage * 100 + 1)));
          break;
        }
        break;
      case SearchEngine.Host.Aol:
        stringBuilder.Append("http://search.aol.com/aol/search?");
        stringBuilder.Append("&q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&page=" + Conversions.ToString(checked (iPage + 1)));
          break;
        }
        break;
      case SearchEngine.Host.Yandex:
        stringBuilder.Append("http://www.yandex.com/yandsearch?");
        stringBuilder.Append("text=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&p=" + Conversions.ToString(iPage));
          break;
        }
        break;
      case SearchEngine.Host.Ask:
        stringBuilder.Append("http://www.ask.com/web?");
        stringBuilder.Append("q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&page=" + Conversions.ToString(iPage));
          break;
        }
        break;
      case SearchEngine.Host.Wow:
        stringBuilder.Append("http://www.wow.com/search?");
        stringBuilder.Append("q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&page=" + Conversions.ToString(checked (iPage + 1)));
          break;
        }
        break;
      case SearchEngine.Host.WebCrawler:
        stringBuilder.Append("http://www.webcrawler.com/search/web?");
        stringBuilder.Append("q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&ridx=" + Conversions.ToString(checked (iPage + 1)));
          break;
        }
        break;
      case SearchEngine.Host.MyWebSearch:
        stringBuilder.Append("http://search.mywebsearch.com/mywebsearch/GGmain.jhtml?");
        stringBuilder.Append("searchfor=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&pn=" + Conversions.ToString(checked (iPage + 1)));
          break;
        }
        break;
      case SearchEngine.Host.Sapo:
        stringBuilder.Append("http://pesquisa.sapo.pt/?");
        stringBuilder.Append("q=" + HttpUtility.UrlEncode(sQuery));
        if (iPage > 0)
        {
          stringBuilder.Append("&page=" + Conversions.ToString(checked (iPage + 1)));
          break;
        }
        break;
    }
    return stringBuilder.ToString();
  }

  private bool IsValidePage(string sData, ref bool bNextPage)
  {
    switch (this.__Host)
    {
      case SearchEngine.Host.Google:
        bNextPage = sData.ToLower().Contains("display:block;margin-left:53px".ToLower());
        return sData.ToLower().Contains("/images/google_favicon_128.png");
      case SearchEngine.Host.Bing:
        bNextPage = sData.ToLower().Contains("sb_pagN".ToLower());
        return sData.ToLower().Contains("schemas.live.com/Web/".ToLower());
      case SearchEngine.Host.Yahoo:
        bNextPage = sData.ToLower().Contains("pg-next".ToLower());
        return sData.ToLower().Contains("l.yimg.com".ToLower());
      case SearchEngine.Host.Aol:
        bNextPage = sData.ToLower().Contains("class=\"\"nextRes\"".ToLower());
        return sData.ToLower().Contains("search.aol.com/rdf/finds".ToLower());
      case SearchEngine.Host.Yandex:
        bNextPage = sData.ToLower().Contains("button__text\">+5<".ToLower());
        return sData.ToLower().Contains("www.yandex.com/clck".ToLower());
      case SearchEngine.Host.Ask:
        bNextPage = sData.ToLower().Contains("nextPageLink".ToLower());
        return sData.ToLower().Contains("sp.ask.com".ToLower());
      case SearchEngine.Host.Wow:
        bNextPage = sData.ToLower().Contains("class=\"\"nextRes\"".ToLower());
        return sData.ToLower().Contains("aolcdn.com".ToLower());
      case SearchEngine.Host.WebCrawler:
        bNextPage = sData.ToLower().Contains("results-bottom".ToLower());
        return sData.ToLower().Contains("class=\"groupTitle\">".ToLower());
      case SearchEngine.Host.MyWebSearch:
        bNextPage = sData.ToLower().Contains("class=\"pag-label\">".ToLower());
        return sData.ToLower().Contains("akd.search.mywebsearch.com".ToLower());
      case SearchEngine.Host.Sapo:
        bNextPage = sData.ToLower().Contains(">seguinte &gt;&gt;<".ToLower());
        return sData.ToLower().Contains("sapo.pt/Prototype/".ToLower());
      default:
        bool flag;
        return flag;
    }
  }

  private bool CheckedCaptcha(string sData)
  {
    switch (this.__Host)
    {
      case SearchEngine.Host.Google:
        return sData.ToLower().Contains("google.com/websearch/answer/86640".ToLower());
      case SearchEngine.Host.Yandex:
        return sData.ToLower().Contains("b-captcha__layout".ToLower());
      case SearchEngine.Host.Ask:
        return sData.ToLower().Contains("bmailto:unauthorized@ask.com".ToLower());
      default:
        bool flag;
        return flag;
    }
  }

  private List<string> ParseURLs(string sData)
  {
    string sRegExp = "";
    switch (this.__Host)
    {
      case SearchEngine.Host.Google:
        sRegExp = Regex.Escape("/url?q=") + "?([^;]+)&amp;";
        break;
      case SearchEngine.Host.Bing:
        sRegExp = "<a\\s+href\\s*=\\s*\"?([^\" >]+)\"";
        break;
      case SearchEngine.Host.Yahoo:
        sRegExp = "RU\\s*=\\s*\"?([^\" >]+)\"";
        break;
      case SearchEngine.Host.Aol:
        sRegExp = "href\\s*=\\s*\"?([^\" >]+)\"";
        break;
      case SearchEngine.Host.Yandex:
        sRegExp = Regex.Escape("url=") + "?([^;]+)&amp;";
        break;
      case SearchEngine.Host.Ask:
        sRegExp = "\\s+href\\s*=\\s*\"?([^\" >]+)\"";
        break;
      case SearchEngine.Host.Wow:
        sRegExp = "href\\s*=\\s*\"?([^\" >]+)\"";
        break;
      case SearchEngine.Host.WebCrawler:
        sRegExp = Regex.Escape("ru=") + "?([^;]+)&amp;";
        break;
      case SearchEngine.Host.MyWebSearch:
        sRegExp = Regex.Escape("class=\"algouri\">") + "?([^<]+)" + Regex.Escape("<");
        break;
      case SearchEngine.Host.Sapo:
        sRegExp = "<a\\s+href\\s*=\\s*\"?([^\" >]+)\"";
        break;
    }
    List<string> stringList1 = this.RegExp(sRegExp, sData);
    List<string> stringList2 = new List<string>();
    try
    {
      foreach (string str1 in stringList1)
      {
        string str2 = str1;
        if (this.__Host == SearchEngine.Host.Google)
        {
          if (str2.IndexOf("&amp;") > 1)
            str2 = str2.Substring(0, str2.IndexOf("&amp;"));
          if (str2.IndexOf("url=") > 1)
            str2 = str2.Substring(checked (str2.IndexOf("url=") + "url=".Length));
          if (str2.IndexOf("&goto=") > 1)
            str2 = "http://" + str2.Substring(checked (str2.IndexOf("&goto=") + "&goto=".Length));
          if (str2.IndexOf("link=") > 1)
            str2 = str2.Substring(checked (str2.IndexOf("link=") + "link=".Length));
          str2 = Strings.Split(HttpUtility.UrlDecode(str2), "=http")[0];
        }
        else if (this.__Host == SearchEngine.Host.Yahoo)
        {
          str2 = HttpUtility.UrlDecode(Strings.Split(str2, "/RK")[0].Trim());
          if (str2.Contains("/search/srpcache"))
            str2 = "";
        }
        else if (this.__Host == SearchEngine.Host.WebCrawler)
          str2 = Strings.Split(str2, "&amp")[0].Trim();
        string strURL = HttpUtility.UrlDecode(str2).Trim();
        if (Globals.G_Scanner.UrlRight(strURL) && Globals.G_Scanner.UrlCanBeExploited(strURL) && !stringList2.Contains(strURL))
          stringList2.Add(strURL);
      }
    }
    finally
    {
      List<string>.Enumerator enumerator;
      enumerator.Dispose();
    }
    checked { this.LinksLoaded += stringList2.Count; }
    return stringList2;
  }

  private List<string> RegExp(string sRegExp, string sData)
  {
    List<string> stringList = new List<string>();
    try
    {
      for (Match match = new Regex(sRegExp, RegexOptions.IgnoreCase).Match(sData); match.Success; match = match.NextMatch())
      {
        string str = match.Groups[1].Value.Trim();
        if (!string.IsNullOrEmpty(str))
          stringList.Add(str);
      }
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      ProjectData.ClearProjectError();
    }
    return stringList;
  }

  private string LoadPage(string sUrl, WebProxy oProxy)
  {
    string str1 = string.Empty;
    bool flag = Globals.G_LOG.EnableLog & Globals.G_LOG.ShowAllLog;
    string sStatus = "";
    string str2 = "";
    TimeSpan ts;
    try
    {
      CookieContainer cookieContainer = new CookieContainer();
      HttpWebRequest httpWebRequest = (HttpWebRequest) WebRequest.Create(sUrl);
      try
      {
        foreach (Cookie cookie in this.__Cookie)
          cookieContainer.Add(new Uri(sUrl), cookie);
      }
      finally
      {
        IEnumerator enumerator;
        if (enumerator is IDisposable)
          (enumerator as IDisposable).Dispose();
      }
      httpWebRequest.UserAgent = Globals.USER_AGENT;
      httpWebRequest.Method = "GET";
      httpWebRequest.Timeout = this.__TimeOut;
      httpWebRequest.ReadWriteTimeout = this.__TimeOut;
      httpWebRequest.CookieContainer = cookieContainer;
      httpWebRequest.AllowAutoRedirect = true;
      httpWebRequest.Proxy = (IWebProxy) oProxy;
      if (flag)
      {
        if (!Information.IsNothing((object) oProxy))
          str2 = oProxy.Address.Host + ":" + Conversions.ToString(oProxy.Address.Port);
        lock (Globals.G_LOG)
          str2 = Globals.G_LOG.AddLog(sUrl, str2);
        ts = new TimeSpan(DateAndTime.Now.Ticks);
      }
      this.ScannerDelay();
      using (HttpWebResponse response = (HttpWebResponse) httpWebRequest.GetResponse())
      {
        using (StreamReader streamReader = new StreamReader(response.GetResponseStream()))
          str1 = streamReader.ReadToEnd();
        if (response.StatusCode == HttpStatusCode.OK)
          this.__Cookie = HttpRequest.SyncCookies(this.__Cookie, response.Cookies);
        sStatus = Conversions.ToString((int) response.StatusCode) + " - " + response.StatusDescription;
      }
    }
    catch (Exception ex)
    {
      ProjectData.SetProjectError(ex);
      sStatus = "Timeout";
      ProjectData.ClearProjectError();
    }
    finally
    {
      if (flag)
      {
        double totalMilliseconds = new TimeSpan(DateAndTime.Now.Ticks).Subtract(ts).TotalMilliseconds;
        lock (Globals.G_LOG)
          Globals.G_LOG.UpdateLog(str2, sUrl, Globals.G_Utilities.FormatBytes((double) str1.Length), Conversions.ToString(totalMilliseconds) + "ms", sStatus);
      }
      checked { Globals.TRAFFIC_RECEIVED += (long) str1.Length; }
      Globals.G_Main.UpDateTrafic();
    }
    return str1;
  }

  public enum Host
  {
    Google,
    Bing,
    Yahoo,
    Aol,
    Yandex,
    Ask,
    Wow,
    WebCrawler,
    MyWebSearch,
    Sapo,
  }

  public enum Worker
  {
    Ide,
    Working,
    Paused,
  }

  public delegate void Scanner_ProgressEventHandler(int percentage, SearchEngine.Host h);

  public delegate void Scanner_LoadedLinkEventHandler(List<string> urls, SearchEngine.Host h);

  public delegate void Scanner_DoneEventHandler(SearchEngine.Host h);

  private class ThreadScanner
  {
    public Thread Thread { get; set; }

    public string Dork { get; set; }
  }
}
