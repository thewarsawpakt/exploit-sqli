// Decompiled with JetBrains decompiler
// Type: Proxy
// Assembly: SQLi Dumper, Version=8.5.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FFDD07D3-5737-4188-BACA-DE2D004C7CCF
// Assembly location: C:\Users\cole\Desktop\SQLi Dumper v8.5 [VeryClean]\SQLi v.8.5 VeryClean by Stephanny.exe

using Microsoft.VisualBasic.CompilerServices;
using System;
using System.Collections;
using System.Net;
using System.Runtime.CompilerServices;
using System.Threading;
using System.Windows.Forms;

public class Proxy
{
  private WebProxy __Proxy;
  private bool __Enable;
  private ArrayList __List;
  private string __IP;
  private const string TEST_ADDRESS = "http://www.google.com/";
  private const int TEST_TIMEOUT = 5000;
  private bool __IsList;
  private global::Proxy.Order __ListOrder;
  private int __ListIndex;
  [SpecialName]
  private int .STATIC.DoProxy.2011280858.LastI;
  [SpecialName]
  private StaticLocalInitFlag .STATIC.DoProxy.2011280858.LastI.Init;

  public Proxy()
  {
    this.__ListIndex = -1;
    this..STATIC.DoProxy.2011280858.LastI.Init = new StaticLocalInitFlag();
  }

  public bool IsList
  {
    get => this.__IsList;
    set => this.__IsList = value;
  }

  public global::Proxy.Order ListType
  {
    get => this.__ListOrder;
    set => this.__ListOrder = value;
  }

  public ArrayList List
  {
    get => this.__List;
    set => this.__List = value;
  }

  public string IP => this.__IP;

  public WebProxy Proxy => this.GetProxy();

  public bool Enable => this.__Enable | this.__IsList;

  private WebProxy GetProxy()
  {
    if (!this.__IsList)
      return this.__Proxy;
    WebProxy webProxy;
    if (this.__ListOrder == global::Proxy.Order.Order)
    {
      if (this.__ListIndex >= checked (this.__List.Count - 1))
        this.__ListIndex = 0;
      else
        checked { ++this.__ListIndex; }
      webProxy = this.DoProxy(this.__ListIndex);
    }
    else
      webProxy = this.DoProxy();
    return webProxy;
  }

  private WebProxy DoProxy(int intIndex = -1)
  {
    if (intIndex != -1)
      return (WebProxy) this.__List[intIndex];
    bool lockTaken = false;
    try
    {
      Monitor.Enter((object) this..STATIC.DoProxy.2011280858.LastI.Init, ref lockTaken);
      if (this..STATIC.DoProxy.2011280858.LastI.Init.State == (short) 0)
      {
        this..STATIC.DoProxy.2011280858.LastI.Init.State = (short) 2;
        this..STATIC.DoProxy.2011280858.LastI = -1;
      }
      else if (this..STATIC.DoProxy.2011280858.LastI.Init.State == (short) 2)
        throw new IncompleteInitialization();
    }
    finally
    {
      this..STATIC.DoProxy.2011280858.LastI.Init.State = (short) 1;
      if (lockTaken)
        Monitor.Exit((object) this..STATIC.DoProxy.2011280858.LastI.Init);
    }
    Random random = new Random(DateTime.Now.Millisecond);
    int index;
    do
    {
      index = random.Next(0, checked (this.__List.Count - 1));
    }
    while (index == this..STATIC.DoProxy.2011280858.LastI);
    this..STATIC.DoProxy.2011280858.LastI = index;
    return (WebProxy) this.__List[index];
  }

  public bool IniProxy(
    string sURL,
    string sUserName,
    string sPassword,
    string sDomain,
    ref string sServer = "",
    ref string sCode = "",
    bool bMsgBox = true)
  {
    bool flag1;
    try
    {
      try
      {
        this.__Proxy = !sURL.StartsWith("http") ? new WebProxy(sURL) : new WebProxy(new Uri(sURL));
      }
      catch (UriFormatException ex)
      {
        ProjectData.SetProjectError((Exception) ex);
        UriFormatException uriFormatException = ex;
        if (bMsgBox)
        {
          int num = (int) MessageBox.Show("URI Format is wrong for proxy address, please fix it!\r\nFormat: address_or_IP:port\r\n" + uriFormatException.Message, "URI format is wrong", MessageBoxButtons.OK, MessageBoxIcon.Hand, MessageBoxDefaultButton.Button1);
        }
        flag1 = false;
        ProjectData.ClearProjectError();
        goto label_12;
      }
      this.__Proxy.BypassProxyOnLocal = false;
      bool flag2 = false;
      if (!(string.IsNullOrEmpty(sUserName) & string.IsNullOrEmpty(sPassword) & string.IsNullOrEmpty(sDomain)))
        this.__Proxy.Credentials = (ICredentials) new NetworkCredential(sUserName, sPassword, sDomain);
      else if (flag2 == (string.IsNullOrEmpty(sUserName) & string.IsNullOrEmpty(sPassword)))
        this.__Proxy.Credentials = (ICredentials) new NetworkCredential(sUserName, sPassword);
      this.__Enable = this.TestOK(this.__Proxy, ref sServer, ref sCode);
      flag1 = this.__Enable;
    }
    catch (WebException ex)
    {
      ProjectData.SetProjectError((Exception) ex);
      WebException webException = ex;
      if (bMsgBox)
      {
        int num = (int) MessageBox.Show(webException.ToString());
      }
      ProjectData.ClearProjectError();
    }
label_12:
    return flag1;
  }

  public void TermProxy()
  {
    this.__Proxy = (WebProxy) null;
    this.__Enable = false;
    this.__IsList = false;
    this.__ListOrder = global::Proxy.Order.Order;
    this.__List = (ArrayList) null;
    this.__ListIndex = 0;
  }

  private bool TestOK(WebProxy oProxy, ref string sServer, ref string sCode)
  {
    string str1 = "";
    string text = "";
    try
    {
      if (oProxy != null)
      {
        this.__Enable = true;
        using (HTTP http1 = new HTTP(5000))
        {
          HTTP http2 = http1;
          string str2 = "";
          ref string local1 = ref str2;
          ref string local2 = ref text;
          str1 = http2.GetHTML("http://www.google.com/", sPostData: (ref local1), bIsDebugable: false, sErrDesc: (ref local2));
          if (http1.WebResponse != null)
          {
            if (http1.WebResponse.HTTPResponse != null)
            {
              sServer = http1.WebResponse.HTTPResponse.Server;
              sCode = Conversions.ToString((int) http1.WebResponse.HTTPResponse.StatusCode) + " - " + http1.WebResponse.HTTPResponse.StatusDescription;
            }
          }
        }
        this.__Enable = false;
        if (!string.IsNullOrEmpty(text))
        {
          int num = (int) MessageBox.Show(text, "Proxy Error", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
        }
      }
    }
    catch (WebException ex)
    {
      ProjectData.SetProjectError((Exception) ex);
      throw ex;
    }
    return !string.IsNullOrEmpty(str1);
  }

  public enum Order
  {
    Order,
    Random,
  }
}
